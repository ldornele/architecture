# HyperFleet Adapter Framework Configuration Template with Maestro Transport
#
# This is an enhanced Configuration Template for configuring cloud provider adapters
# using the HyperFleet Adapter Framework with Maestro transport capabilities for
# remote cluster resource management.
#
# TRANSPORT CLIENTS:
# ================
# - hyperfleet: HyperFleet API client
# - maestro: Maestro transport client
#
apiVersion: hyperfleet.redhat.com/v1alpha1
kind: AdapterConfig
metadata:
  # Adapter name (used as resource name and in logs/metrics)
  name: aro-hcp-adapter
  namespace: hyperfleet-system
  labels:
    hyperfleet.io/adapter-type: aro-hcp
    hyperfleet.io/component: adapter
    hyperfleet.io/transport: maestro

# ============================================================================
# Adapter Specification
# ============================================================================
spec:
  # Adapter Information
  adapter:
    # Adapter version
    # Only check major and minor version for compatibility
    # PATCH version can be omitted to "0.2"
    version: "0.2.0"

  # ============================================================================
  # NEW: Clients Configuration
  # ============================================================================
  # Defines how resources are managed (hyperfleet api client vs transport client)

  clients:
    # Maestro-specific configuration this is optional and only used if the adapter uses Maestro transport
    maestro:
      # Maestro gRPC server connection (for ManifestWork operations)
      # it can be set by the adapter deployment configmap environment variable HYPERFLEET_MAESTRO_GRPC_SERVER_ADDRESS or flag --maestro-grpc-server-address
      grpcServerAddress: "{{ .config.maestro.grpcServerAddress }}"
      # Maestro HTTPS server connection (for REST API operations)
      # it can be set by the adapter deployment configmap environment variable HYPERFLEET_MAESTRO_HTTP_SERVER_ADDRESS or flag --maestro-http-server-address
      httpServerAddress: "{{ .config.maestro.httpServerAddress }}"
      # Source identifier for CloudEvents routing and status subscription
      # it is the adapter name, must be unique across adapters to avoid CloudEvent conflicts
      sourceId: "{{ .metadata.name }}"

      # Authentication configuration
      auth:
        # Authentication type: "tls" (certificate-based mTLS)
        type: "tls"

        # TLS certificate configuration
        tlsConfig:
          # Certificate Authority file path
          # it can be set by the adapter deployment configmap environment variable HYPERFLEET_MAESTRO_CA_FILE or flag --maestro-ca-file
          caFile: "{{ .config.maestro.caFile }}"
          # Client certificate file path
          # it can be set by the adapter deployment configmap environment variable HYPERFLEET_MAESTRO_CERT_FILE or flag --maestro-cert-file
          certFile: "{{ .config.maestro.certFile }}"
          # Client private key file path
          # it can be set by the adapter deployment configmap environment variable HYPERFLEET_MAESTRO_KEY_FILE or flag --maestro-key-file
          keyFile: "{{ .config.maestro.keyFile }}"
          # Server name for TLS verification (used for both gRPC and HTTPS)
          # it can be set by the adapter deployment configmap environment variable HYPERFLEET_MAESTRO_SERVER_NAME or flag --maestro-server-name
          serverName: "{{ .config.maestro.serverName }}" 

      # Connection and timeout settings
      timeout: "30s"
      retryAttempts: 3
      retryBackoff: "exponential"

      # Keep-alive settings for long-lived gRPC connections
      keepalive:
        time: "30s"
        timeout: "10s"
        permitWithoutStream: true

  # ============================================================================
  # HyperFleet API Configuration
  # ============================================================================
    httpAPI:
      # HTTP client timeout for API calls
      timeout: 2s
      # Number of retry attempts for failed API calls
      retryAttempts: 3
      # Retry backoff strategy: exponential, linear, constant
      retryBackoff: exponential
    
    kubernetes:
      apiVersion: "v1"
      # optional: kubeconfig file path
      # it can be set by the adapter deployment configmap environment variable HYPERFLEET_KUBECONFIG or flag --kubeconfig
      # when the kubeconfig value is not set, the adapter will check if host and token are set, if not it will use the in-cluster service account token for authentication
      kubeconfig: "{{ .config.kubeconfig }}"
      
      # optional: host and token for direct authentication
      # it can be set by the adapter deployment configmap environment variable HYPERFLEET_KUBECONFIG_HOST or flag --kubeconfig-host
      host: "{{ .config.host }}"
      # it can be set by the adapter deployment configmap environment variable HYPERFLEET_KUBECONFIG_TOKEN or flag --kubeconfig-token
      token: "{{ .config.token }}"
      # it can be set by the adapter deployment configmap environment variable HYPERFLEET_KUBECONFIG_CA_FILE or flag --kubeconfig-ca-file
      caFile: "{{ .config.caFile }}"